#!/usr/bin/env gjs

/*! (c) Andrea Giammarchi - ISC */

const { gi, searchPath, system } = imports;

const { GLib, Gio } = gi;
const { File } = Gio;

const DIR = GLib.get_current_dir();
const PROGRAM = resolve(DIR, system.programInvocationName);
const cache = Object.create(null);

let __dirname = getProgramDir(PROGRAM).get_path();
let __filename = PROGRAM.get_path();

Object.defineProperties(window, {
  __dirname: {get: () => __dirname},
  __filename: {get: () => __filename},
  global: {value: window},
  require: {value(file) {
    if (/^[A-Z]/.test(file))
      return file.split('.').reduce(($, k) => $[k], gi);
    if (!/\.js$/.test(file))
      file += '.js';
    const fd = resolve(__dirname, file);
    const fn = fd.get_path();
    if (fn in cache)
      return cache[fn];
    const dn = fd.get_parent().get_path();
    const _fn = __filename;
    const _dn = __dirname;
    const exports = {};
    const module = { exports };
    window.exports = exports;
    window.module = module;
    __filename = fn;
    __dirname = dn;
    searchPath.unshift(dn);
    imports[fd.get_basename().replace(/\.js$/, '')];
    cache[fn] = module.exports;
    searchPath.shift();
    __filename = _fn;
    __dirname = _dn;
    return module.exports;
  }}
});

ARGV.forEach(arg => {
  const fd = resolve(DIR, arg);
  if (fd.query_exists(null))
    window.require(fd.get_path());
});

function resolve(dir, file) {
  return File.new_for_path(dir).resolve_relative_path(file);
}

function getProgramDir(programFile) {
  const info = programFile.query_info('standard::', Gio.FileQueryInfoFlags.NOFOLLOW_SYMLINKS, null);
  if (info.get_is_symlink()) {
    const symlinkFile = programFile.get_parent().resolve_relative_path(info.get_symlink_target());
    return symlinkFile.get_parent();
  } else {
    return programFile.get_parent();
  }
}
